name: Build ImmortalWrt for JDCloud Taiyi Plus
on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '24.10'
      branch:
        description: 'ImmortalWrt分支'
        required: false
        default: 'openwrt-24.10'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      - name: 1. 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget curl subversion \
          swig libelf-dev libncurses-dev device-tree-compiler ccache \
          ecj fastjar java-propose-classpath python2 python3 python3-pip \
          python3-setuptools python3-wheel cmake ninja-build libtool autoconf automake
          
          # 配置ccache
          sudo mkdir -p /mnt/ccache
          sudo chown -R $USER:$USER /mnt/ccache
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=15G" >> $GITHUB_ENV
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          
          # 设置时区和磁盘检查
          sudo timedatectl set-timezone "Asia/Shanghai"
          df -h

      - name: 2. 克隆源码
        run: |
          if [ -z "${{ github.event.inputs.branch }}" ]; then
            BRANCH="openwrt-24.10"
          else
            BRANCH="${{ github.event.inputs.branch }}"
          fi
          
          git clone --depth 1 -b $BRANCH https://github.com/immortalwrt/immortalwrt.git immortalwrt
          cd immortalwrt
          
          # 添加feeds
          echo "src-git packages https://github.com/immortalwrt/packages.git;$BRANCH" > feeds.conf.default
          echo "src-git luci https://github.com/immortalwrt/luci.git;$BRANCH" >> feeds.conf.default
          echo "src-git routing https://github.com/immortalwrt/routing.git;$BRANCH" >> feeds.conf.default
          echo "src-git telephony https://github.com/immortalwrt/telephony.git;$BRANCH" >> feeds.conf.default
          echo "src-git istore https://github.com/linkease/istore-core.git;main" >> feeds.conf.default
          
          # 创建设备树目录
          mkdir -p target/linux/ipq53xx/files/arch/arm64/boot/dts/qcom

      - name: 3. 写入设备树文件（Base64编码规避语法冲突）
        run: |
          # 设备树文本Base64编码后解码写入，彻底避免YAML解析错误
          echo "LyBTUERYLUluaXRpYWxpemF0aW9uLUlkaWVzZToiIEdQTC0yLjAtb3ItbGF0ZXIgT1IgTUlUIgpvZnRsaW5lL2Q0LnR4dDsKaW5jbHVkZSAiaXBxNTMyMi5kdHNpIgoKLwoKLyB7CiAgICBtb2RlbCA9ICJKRENsb3VkIFRhaXlpIFBsdXMgKEVSMikiOwogICAgY29tcGF0aWJsZSA9ICJqZGNsb3VkLHRhaWl5LXBsdXMsInFjb20saXBxNTMyMiI7CgogICAgbWVtb3J5QDAgewogICAgICAgIGRldmljZV90eXBlID0gIm1lbW9yeSI7CiAgICAgICAgcmVnID0gPDAuMCAwLjAgMC4wIDguMDAwMDAwMD47CiAgICB9OwoKICAgIGNob2Nlc2VuIHsKICAgICAgICBib290YXJncyA9ICJjb25zb2xlPXR0eU1TTTAwLDExNTIwMG44IHJvb3Rmc3R5cGU9c3F1YXNoZnMsaWpmZnMyIjsKICAgIH07CgogICAgYWxpYXNlcyB7CiAgICAgICAgc2VyaWFsMCA9ICZibHNwMV91YXJ0MTsKICAgICAgICBldGhlcm5ldDAgPSAmZ21hYzA7CiAgICAgICAgZXRoZXJuZXQxID0gJmdtYWMxOwogICAgICAgIGV0aGVybmV0MiA9ICZnbWFjMjsKICAgICAgICBldGhlcm5ldDMgPSAmZ21hYzM7CiAgICB9Owp9OwoKKmJsc3AxX3VhcnQxIHsKICBzdGF0dXMgPSAiYWthYXkiOyB9OwoKKmdtYWMwIHsKICBzdGF0dXMgPSAiYWthYXkiOwogIHBoeS1tb2RlID0gIjI1MDBiYXNlLXgiOwogIGZpeGVkLWxpbmsgewoJc3BlZWQgPSAyNTAwOwogICBmdWxsLWR1cGxleDsgCiAgfTsKfTsKKmdtYWMxIHsKICBzdGF0dXMgPSAiYWthYXkiOwogIHBoeS1tb2RlID0gIjI1MDBiYXNlLXgiOwogIGZpeGVkLWxpbmsgewoJc3BlZWQgPSAyNTAwOwogICBmdWxsLWR1cGxleDsgCiAgfTsKfTsKKmdtYWMyIHsKICBzdGF0dXMgPSAiYWthYXkiOwogIHBoeS1tb2RlID0gIjI1MDBiYXNlLXgiOwogIGZpeGVkLWxpbmsgewoJc3BlZWQgPSAyNTAwOwogICBmdWxsLWR1cGxleDsgCiAgfTsKfTsKKmdtYWMzIHsKICBzdGF0dXMgPSAiYWthYXkiOwogIHBoeS1tb2RlID0gIjI1MDBiYXNlLXgiOwogIGZpeGVkLWxpbmsgewoJc3BlZWQgPSAyNTAwOwogICBmdWxsLWR1cGxleDsgCiAgfTsKfTsKKm1kaW8gewogIHN0YXR1cyA9ICJva2F5IjsKCgogIHBoeTA6IGV0aGVybmV0LXBoeUBwIHsKICByZWcgPSAwOyB9OwoKICBwaHkxOiBldGhlcm5ldC1waHlAcCB7CiAgcmVnID0gMTsgfTsKCgogIHBoeTI6IGV0aGVybmV0LXBoeUBwIHsKICByZWcgPSAyOyB9OwoKICBwaHkzOiBldGhlcm5ldC1waHlAcCB7CiAgcmVnID0gMzsgfTsKfTsKKm5hbmQgewogIHN0YXR1cyA9ICJva2F5IjsKCgogIG5hbmRAwCB7CiAgICBwYXJ0aXRpb25zIHsKICAgICAgICBjb21wYXRpYmxlID0gImZpeGVkLXBhcnRpdGlvbnMiOwogICAgICAgI2FkZHJlc3NzLWNlbGxzID0gPDE+OwogICAgICAgI3NpemUtY2VsbHMgPSA8MT47CgogICAgICBwYXJ0aXRpb25A MCAgewogICAgICAgIGxhYmVsID0gIjA6Qkw7IgogICAgICAgIHJlZyA9IDwwLjAwMDAwMDAgMC4wNTAwMDAwPjsKICAgICAgICByZWFkLW9ubHkgPSB0cnVlOwogICAgICB9OwoKICAgICAgcGFydGl0aW9uQDUwMDAwMCAgewogICAgICAgIGxhYmVsID0gIjA6S2VybmVsOwogICAgICAgIHJlZyA9IDwwLjA1MDAwMDAgMC4yMDAwMDAwPjsKICAgICAgfTsKCgogICAgICBwYXJ0aXRpb25AMjUwMDAwMCAgewogICAgICAgIGxhYmVsID0gIjA6Um9vdEZTOyIKICAgICAgICByZWcgPSAwLjI1MDAwMDAgMC43ZmIwMDAwPjsKICAgICAgfTsKICAgIH07CiAgfTsKfTs=" | base64 -d > immortalwrt/target/linux/ipq53xx/files/arch/arm64/boot/dts/qcom/ipq5322-jdcloud-taiyi-plus.dts

      - name: 4. 添加设备编译条目（Base64编码）
        run: |
          # Makefile内容Base64编码解码写入
          echo "CgpCSkNsb3VkIFRhaXlpIFBsdXMgKElwUTUzMjIpCmRlZmluZSBEZXZpY2UvamRjbG91ZC10YWl5aS1wbHVzCiAgJChjYWxsIERldmljZS9GaXRJbWFnZUx6bWEpCiAgJChjYWxsIERldmljZS9VYmlGaXQpCiAgREVWSUNFX1ZFTkRPUiA9OiBKRENsb3VkCiAgREVWSUNFX01PREVMID06IFRhaXlpIFBsdXMgKEVSMikiCiAgREVWSUNFX0RUUyA9OiBpcHE1MzIyLWpkY2xvdWQtdGFpeWktcGx1cwogIEROQVZJQ0VfRFRTX0RSSVIgPSAkKERUU19ESVIpL3Fjb20KICBESUFWRUNFX0RUU19DT05GSUMgPSBjb25maWdAMQogIEJMT0NLR0lTRSA9OiAxMjhrCiAgUEFHRVNJUEUgPSAyMDQ4CiAgSU1BR0VfU0l6ZSA9IDMyNzY4awogIEtFUk5FTExfSU5fVUJJID0gMQogIFVCT09URU5WX0lOX1VCSSA9IDEKICBVQklOSVpFX09QVFMgPSAtRSA1CiAgREVWSUNFX1BBQ0tBR0VTIj0ga21vZC11c2IzIGttb2Qtc2ZwCmVuZGVmClRBUkdFVF9ERVZJQ0VTICs9IGpkY2xvdWQtdGFpeWktcGx1cw==" | base64 -d >> immortalwrt/target/linux/ipq53xx/image/Makefile

      - name: 5. 启用硬件加速
        run: |
          echo -e "\n# IPQ5322硬件优化" >> immortalwrt/target/linux/ipq53xx/config-6.6
          echo "CONFIG_CPU_FREQ=y" >> immortalwrt/target/linux/ipq53xx/config-6.6
          echo "CONFIG_ARM_QCOM_CPUFREQ_NVMEM=y" >> immortalwrt/target/linux/ipq53xx/config-6.6
          echo "CONFIG_XFRM_OFFLOAD=y" >> immortalwrt/target/linux/ipq53xx/config-6.6
          echo "CONFIG_NET_SWITCHDEV=y" >> immortalwrt/target/linux/ipq53xx/config-6.6

      - name: 6. 更新feeds并安装
        run: |
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -y -p istore luci luci-compat luci-theme-argon

      - name: 7. 生成编译配置（Base64编码）
        run: |
          cd immortalwrt
          # .config内容Base64编码解码写入
          echo "Q09ORklHX1RBQkdFUl9xdWFsY29tbWF4PXkKQ09ORklHX1RBQkdFUl9xdWFsY29tbWF4X2lwcTUzeHg9eQpDT05GRUdUX1RBR0VSX3F1YWxjb21tYXhfaXBxNTN4eF9ERklWQUNFX2pkY2xvdWQtdGFpeWktcGx1cz15CgojIOi9veS6p+S6uuS6rwogQ09ORklHX1BBQ0tBR0VfbHVjaT15CkNPTkZJR19QQUNLQVRFX2x1Y2ktdGhlbWUtYXJnb249eQpDT05GRUdUX1BBQ0tBR0VfbHVjaS1pMW5uLWJhc2UtemgtY249eQpDT05GRUdUX1BBQ0tBR0VfbHVjaS1hcHAtb3BrZz15CkNPTkZJR19QQUNLQVRFX2x1Y2ktYXBwLWZpcmV3YWxsPXkKQ09ORklHX0RFRkFVTFRfbHVjaV90aGVtZT0iYXJnb24iCkNPTkZJR19QQUNLQVRFX29wZW5zc2gtc2Z0cC1zZXJ2ZXI9eQpDT05GRUdUX1BBQ0tBR0VfY3VybD15CkNPTkZJR19QQUNLQVRFX2h0b3A9eQpDT05GRUdUX1BBQ0tBR0VfaXBlcmYzPXkKQ09ORklHX1BBQ0tBR0Vfd2dldC1zc2w9eQoKIyBpU3RvcmUg5bm/54K56KOF5ZGYCkNPTkZJR19QQUNLQVRFX2x1Y2ktYXBwLXN0b3JlPXkKQ09ORklHX1BBQ0tBR0VfbHVjaS1pMW5uLXN0b3JlLXpoLWNuPXkKQ09ORklHX1BBQ0tBR0VfYXBwLW1ldGEtZGRucz15CkNPTkZJR19QQUNLQVRFX2FwcC1tZXRhLXBhc3N3YWxsPXkKCiMg57G757uf5优化CkNPTkZJR19QQUNLQVRFX2ttb2QtdGNwLWJicj15CkNPTkZJR19QQUNLQVRFX2x1Y2ktYXBwLXNxbT15CkNPTkZJR19QQUNLQVRFX2ttb2QtaXB0LW9mZmxhbGQ9eQpDT05GRUdUX1BBQ0tBR0Vfa21vZC1uZi1mbG93dGFibGU9eQoKIyDepoiQ6LWE5pawCkNPTkZJR19QQUNLQVRFX2ttb2QtdXNiczM9eQpDT05GRUdUX1BBQ0tBR0Vfa21vZC1zZnA9eQpDT05GRUdUX1BBQ0tBR0Vfa21vZC1waHktcWNhODA3NT15CgojIOaWsOmDveWFseKIhjxCkNPTkZJR19QQUNLQVRFX2ttb2QtZnMtZXh0ND15CkNPTkZJR19QQUNLQVRFX2ttb2QtZnMtdmZhdD15CkNPTkZJR19QQUNLQVRFX2ttb2QtdXNici1zdG9yYWdlPXkKCiMgSFR2NgpDT05GRUdJX0lQVjY9eQpDT05GRUdUX1BBQ0tBR0Vfb2RoY3A2Yz15CkNPTkZJR19QQUNLQVRFX29kaGNwZD15CkNPTkZJR19QQUNLQVRFX2x1Y2ktcHJvdG8taXB2Nj15CgojIOi9veWFseWFseAojIyBDb25maWd8dGFyZ2V0X3Jvb3Rmc19zcXVhc2hmc2k9eQojIyBDb25maWd8dGFyZ2V0X3NxdWFzaGZzX2Jsb2NrX3NpemU9MjU2CkNPTkZJR19NVURfU1BJX05PUl9VU0VfNEtfU0VDVE9SU1M9eQpDT05GRUdJTl9OQU5EX1BBR0VTX1NJWkVMPTIwNDgKQ09ORklHTl9OQU5EX09PQl9TSVpFPTEyOAoKQ09ORklHTl9OQU5EX0JMT0NLRF9TSVpFPTEyOGsKQ09ORklHX1RBQkdFUl9ST09URlNTX1NRVUFTSGZmc2k9eQpDT05GRUdUX1RBQkdFUl9TUVVBU0hGU1NfQkxPQ0tfU0laRT0yNTYK" | base64 -d > .config
          make defconfig

      - name: 8. 下载依赖包
        run: |
          cd immortalwrt
          make download -j$(nproc)
          find dl -size -1024c -delete

      - name: 9. 编译固件
        run: |
          cd immortalwrt
          ccache -s
          make -j$(nproc) V=s || make -j1 V=s
          ccache -s
          echo "FIRMWARE_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "FIRMWARE_TIME=$(date +'%H%M')" >> $GITHUB_ENV

      - name: 10. 整理固件文件
        run: |
          cd immortalwrt
          mkdir -p firmware
          find bin/targets/qualcommax/ipq53xx -type f \( -name "*.bin" -o -name "*.ubi" -o -name "*.img" \) -exec cp {} firmware/ \;
          zip -r firmware.zip firmware/

      - name: 11. 上传固件到Releases
        uses: softprops/action-gh-release@v2
        with:
          name: TaiyiPlus-ImmortalWrt-${{ env.FIRMWARE_DATE }}-${{ env.FIRMWARE_TIME }}
          tag_name: v${{ env.FIRMWARE_DATE }}-${{ env.FIRMWARE_TIME }}
          files: immortalwrt/firmware.zip
          body: |
            ## 京东云太乙Plus专用固件
            **版本**: ImmortalWrt ${{ github.event.inputs.version || '24.10' }}
            **编译时间**: ${{ env.FIRMWARE_DATE }} ${{ env.FIRMWARE_TIME }}
            
            ### 硬件适配
            - CPU: IPQ5322 四核 1.5GHz
            - RAM: 2GB DDR4
            - 网口: 4×2.5G RJ45
            - USB: 1×USB 3.0
            
            ### 默认配置
            IP地址: 192.168.1.1  
            用户名: root  
            密码: password
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 12. 清理工作空间
        if: always()
        run: |
          rm -rf immortalwrt
          ccache -C
